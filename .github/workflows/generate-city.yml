name: Generate Procedural City

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '30 * * * *'  # Every 1 hour (IST-aligned: runs at :00 IST)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install radon requests

      - name: Run city generator
        id: evolve
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python evolve.py
          echo "TIMESTAMP=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_ENV
          # Extract some stats for the PR description
          STATS=$(jq -r '.stats | "Density: \(.urban_density)\nHealth: \(.mainframe_health)\nLoad: \(.system_load)"' city.json)
          echo "STATS<<EOF" >> $GITHUB_ENV
          echo "$STATS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          # Force a change detection by adding run ID
          jq '.stats.cycle_id = "${{ github.run_id }}"' city.json > city_temp.json && mv city_temp.json city.json

      - name: Autonomous PR Flow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Autogit Evolution Bot"
          git config user.email "bot@autogit.local"
          
          BRANCH="evolution/cycle-${{ github.run_id }}"
          git checkout -b $BRANCH
          git add city.json
          if git diff --cached --quiet; then
            echo "No structural changes detected‚Äîskipping PR but logging cycle."
            # Still commit for history
            git commit -m "üèôÔ∏è Idle Evolution Cycle: ${{ env.TIMESTAMP }} (No Changes)"
          else
            git commit -m "üèôÔ∏è Evolution Cycle: ${{ env.TIMESTAMP }}"
          fi
          git push origin $BRANCH
          
          # Create PR always for visibility
          PR_URL=$(gh pr create \
            --title "üß¨ Autonomous Evolution Cycle: ${{ env.TIMESTAMP }}" \
            --body "### Simulation Report
            The city has pulsed. üèôÔ∏è
            
            **Metrics:**
            ${{ env.STATS }}
            
            *Generated autonomously by the Autogit Evolution Engine.*" \
            --base main \
            --head $BRANCH)
          
          # Immediate Merge
          gh pr merge $PR_URL --squash --delete-branch

      - name: Raise Issue on Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "‚ò¢Ô∏è CRITICAL: Evolution Subsystem Failure" \
            --body "The evolution cycle at ${{ env.TIMESTAMP }} failed to initialize.
            
            **Run ID**: ${{ github.run_id }}
            **Workflow**: ${{ github.workflow }}
            
            Please inspect the action logs immediately to prevent mainframe degradation."